<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>REPORT IFP 2025 GUNUNGKIDUL</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body{font-family:Arial,sans-serif;background:#667eea;padding:15px;margin:0;min-height:100vh}
    .container{max-width:800px;margin:0 auto;background:#fff;border-radius:20px;padding:25px;box-shadow:0 15px 40px rgba(0,0,0,0.3)}
    h1{text-align:center;font-size:24px;background:linear-gradient(45deg,#1a237e,#4a148c);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .badge{background:#4caf50;color:#fff;padding:6px 16px;border-radius:30px;font-size:14px}
    label{display:block;margin:15px 0 6px;font-weight:bold;color:#333}
    .required::after{content:" *";color:red}
    input,select,textarea{width:100%;padding:14px;border:2px solid #ddd;border-radius:12px;font-size:16px;margin-bottom:10px}
    .card{background:#f8faff;border:2px dashed #bbdefb;border-radius:15px;padding:20px;margin:20px 0}
    .header{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px}
    .no{background:#5c6bc0;color:#fff;width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:bold}
    .btn{padding:16px;border:none;border-radius:12px;font-size:18px;font-weight:bold;cursor:pointer;width:100%;margin:10px 0;color:#fff}
    .btn-add{background:#29b6f6}
    .btn-download{background:#ff9800}
    .btn-wa{background:#25d366;box-shadow:0 4px 15px rgba(37,211,102,0.4)}
    .btn-wa:disabled{background:#999;cursor:not-allowed;opacity:0.6}
    .btn-hapus{background:#f44336}
    .counter{position:fixed;top:15px;right:15px;background:#fff;padding:12px 24px;border-radius:50px;box-shadow:0 5px 20px rgba(0,0,0,0.2);font-weight:bold;color:#5c6bc0;z-index:999}
    .success-box{margin:25px 0;padding:25px;background:#e8f5e9;border:3px solid #4caf50;border-radius:15px;text-align:center;display:none}
    .success-box h3{font-size:22px;margin:0 0 15px;color:#2e7d32}
    .success-box p{font-size:16px;color:#1b5e20;margin:10px 0}
  </style>
</head>
<body>

<div class="counter" id="counter">Sekolah: 1</div>

<div class="container">
  <h1>REPORT INSTALASI IFP 2025</h1>
  <center><span class="badge">KABUPATEN GUNUNGKIDUL</span></center>
  <p style="text-align:center;color:#555;margin:15px 0">
    NPSN Sesuai Yang ada Di BAPP HALAMAN PERTAMA • Wajib download Excel dulu → baru bisa kirim ke Admin
  </p>

  <b>DATA TEKNISI</b>
  <label class="required">Nama Teknisi</label>
  <input type="text" id="namaTeknisi" placeholder="Masukkan nama lengkap">

  <label class="required">No WhatsApp</label>
  <input type="text" id="waTeknisi" placeholder="08xxxxxxxxxx">

  <b style="display:block;margin:30px 0 10px">DAFTAR SEKOLAH</b>
  <div id="sekolahList">
    <div class="card" id="sekolah-1">
      <div class="header">
        <div class="no">1</div>
        <button type="button" class="btn btn-hapus" onclick="hapusSekolah(1)" style="display:none;width:auto;padding:8px 16px;font-size:14px">Hapus</button>
      </div>
      <label class="required">Nama Sekolah</label>
      <input type="text" class="nama" placeholder="Contoh: SMPN 1 Wonosari">
      <label class="required">NPSN</label>
      <input type="text" class="npsn" placeholder="Sesuaikan NPSN di BAPP HALAMAN PERTAMA">
      <label>Status</label>
      <select class="status">
        <option value="Selesai">Selesai Terinstall</option>
        <option value="Bermasalah">Ada Kendala</option>
        <option value="Belum Listrik">Belum Ada Listrik</option>
        <option value="Jaringan">Masalah Jaringan</option>
        <option value="Lainnya">Lainnya</option>
      </select>
      <label>Catatan (opsional)</label>
      <textarea class="catatan" rows="2"></textarea>
    </div>
  </div>

  <button type="button" class="btn btn-add" onclick="tambahSekolah()">+ Tambah Sekolah</button>

  <!-- Tombol utama -->
  <button type="button" class="btn btn-download" onclick="downloadExcelDulu()">
    DOWNLOAD FILE EXCEL SEKARANG
  </button>

  <!-- Box konfirmasi setelah download -->
  <div id="konfirmasiDownload" class="success-box">
    <h3>FILE EXCEL SUDAH BERHASIL DI-DOWNLOAD!</h3>
    <p id="namaFileInfo"></p>
    <p>Sekarang lanjutkan kirim ke Admin WhatsApp</p>
    <button type="button" class="btn btn-wa" id="btnLanjutWA">
      LANJUTKAN KE WHATSAPP ADMIN
    </button>
  </div>
</div>

<script>
  const ADMIN_WA = "6281383796300";
  let jumlahSekolah = 1;
  let dataReport = null;        // Menyimpan data sementara
  let namaFileExcel = "";       // Nama file yang didownload

  function tambahSekolah() {
    jumlahSekolah++;
    const div = document.createElement('div');
    div.className = 'card';
    div.id = 'sekolah-' + jumlahSekolah;
    div.innerHTML = `
      <div class="header">
        <div class="no">${jumlahSekolah}</div>
        <button type="button" class="btn btn-hapus" onclick="hapusSekolah(${jumlahSekolah})" style="width:auto;padding:8px 16px;font-size:14px">Hapus</button>
      </div>
      <label class="required">Nama Sekolah</label>
      <input type="text" class="nama">
      <label class="required">NPSN</label>
      <input type="text" class="npsn">
      <label>Status</label>
      <select class="status">
        <option value="Selesai">Selesai Terinstall</option>
        <option value="Bermasalah">Ada Kendala</option>
        <option value="Belum Listrik">Belum Ada Listrik</option>
        <option value="Jaringan">Masalah Jaringan</option>
        <option value="Lainnya">Lainnya</option>
      </select>
      <label>Catatan</label>
      <textarea class="catatan" rows="2"></textarea>
    `;
    document.getElementById('sekolahList').appendChild(div);
    document.getElementById('counter').textContent = 'Sekolah: ' + jumlahSekolah;
  }

  function hapusSekolah(id) {
    if (jumlahSekolah <= 1) return;
    document.getElementById('sekolah-'+id).remove();
    jumlahSekolah--;
    document.querySelectorAll('.card').forEach((c,i) => {
      c.id = 'sekolah-'+(i+1);
      c.querySelector('.no').textContent = i+1;
      c.querySelector('.btn-hapus').onclick = () => hapusSekolah(i+1);
      c.querySelector('.btn-hapus').style.display = (i===0) ? 'none' : 'block';
    });
    document.getElementById('counter').textContent = 'Sekolah: ' + jumlahSekolah;
  }

  // LANGKAH 1: Download Excel dulu
  function downloadExcelDulu() {
    const nama = document.getElementById('namaTeknisi').value.trim();
    const wa = document.getElementById('waTeknisi').value.trim();
    if (!nama || !wa) return alert("Isi dulu Nama & WA Teknisi!");

    const data = [];
    let valid = 0;
    document.querySelectorAll('.card').forEach((card, i) => {
      const sekolah = card.querySelector('.nama').value.trim();
      const npsn = card.querySelector('.npsn').value.trim();
      if (sekolah && npsn) {
        data.push({
          no: i+1,
          sekolah: sekolah,
          npsn: npsn,
          status: card.querySelector('.status').value,
          catatan: card.querySelector('.catatan').value.trim()
        });
        valid++;
      }
    });

    if (valid === 0) return alert("Isi minimal 1 sekolah dengan lengkap!");

    // Simpan data sementara
    dataReport = { nama, wa, data, valid };

    // Buat & download Excel
    const wb = XLSX.utils.book_new();
    const rows = [
      ["REPORT INSTALASI IFP GUNUNGKIDUL 2025"],
      ["Tanggal", new Date().toLocaleString('id-ID')],
      ["Teknisi", nama],
      ["WA Teknisi", wa],
      ["Total Sekolah", valid],
      [],["No","Nama Sekolah","NPSN","Status","Catatan"]
    ];
    data.forEach(d => rows.push([d.no, d.sekolah, d.npsn, d.status, d.catatan]));
    const ws = XLSX.utils.aoa_to_sheet(rows);
    ws['!cols'] = [{wch:6},{wch:40},{wch:22},{wch:20},{wch:40}];
    XLSX.utils.book_append_sheet(wb, ws, "Report");

    namaFileExcel = `Report_IFP_${nama.replace(/[^a-zA-Z0-9]/g,"_")}_${new Date().toISOString().slice(0,10)}.xlsx`;
    XLSX.writeFile(wb, namaFileExcel);

    // Tampilkan konfirmasi + aktifkan tombol WA
    document.getElementById('namaFileInfo').textContent = `File: ${namaFileExcel}`;
    document.getElementById('konfirmasiDownload').style.display = 'block';
    document.getElementById('btnLanjutWA').disabled = false;
  }

  // LANGKAH 2: Setelah download, baru boleh ke WA
  document.getElementById('btnLanjutWA').addEventListener('click', function() {
    if (!dataReport) return;

    const { nama, wa, valid } = dataReport;
    const pesan = encodeURIComponent(
`*REPORT INSTALASI IFP 2025 - GUNUNGKIDUL*

Teknisi: *${nama}*
WA: ${wa}
Tanggal: ${new Date().toLocaleDateString('id-ID')}
Total: ${valid} sekolah

File Excel "${namaFileExcel}" sudah ter-download.
Silakan lampirkan file tersebut dan kirim ke Admin.
Terima kasih!`
    );

    window.open(`https://wa.me/${ADMIN_WA}?text=${pesan}`, '_blank');
  });
</script>
</body>
</html>
